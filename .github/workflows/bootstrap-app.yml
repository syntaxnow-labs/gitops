name: Bootstrap GitOps App Structure

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Application name (example: repository name)"
        required: true
        type: string

      app_type:
        description: "Application type (backend / frontend)"
        required: true
        type: string

      deploy_envs:
        description: >
          Environments to deploy (comma-separated: dev,qa,prod).
          Leave empty for scaffold-only.
          Example: dev / dev,qa / dev,qa,prod
        required: false
        default: ""
        type: string
        
      with_secrets:
        description: "Does this app require Vault secrets? (true / false)"
        required: false
        default: "false"
        type: string

jobs:
  scaffold:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------
      # Step 1: Checkout GitOps Repo
      # ---------------------------------------------
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_TOKEN }}

      # ---------------------------------------------
      # Step 2: Run Bootstrap Script
      # Creates app structure + optional env enablement
      # ---------------------------------------------
      - name: Run bootstrap script
        run: |
          echo "Bootstrapping GitOps structure..."
          echo "App Name   : ${{ inputs.app_name }}"
          echo "App Type   : ${{ inputs.app_type }}"
          echo "Deploy Envs: ${{ inputs.deploy_envs }}"
          echo "With Secrets: ${{ inputs.with_secrets }}"

          chmod +x scripts/bootstrap-app.sh

          ./scripts/bootstrap-app.sh \
            "${{ inputs.app_name }}" \
            "${{ inputs.app_type }}" \
            "${{ inputs.deploy_envs }}" \
            "${{ inputs.with_secrets }}"

          echo "Bootstrap completed."

      # ---------------------------------------------
      # Step 3: Commit & Push Changes
      # Includes scaffold + env registration updates
      # ---------------------------------------------
      - name: Commit & Push scaffold
        run: |
          echo "Preparing Git commit..."

          git config user.name "GitOps Bootstrap Bot"
          git config user.email "actions@github.com"

          # Stage both app scaffold + cluster env list changes
          git add apps/ clusters/vm-0656/apps-*.yaml

          # Prevent failure if no changes exist
          if git diff --cached --quiet; then
            echo "No changes detected — skipping commit."
            exit 0
          fi

          git commit -m "Bootstrap ${{ inputs.app_name }} (${{ inputs.app_type }}) → envs: [${{ inputs.deploy_envs }}] → secrets: [${{ inputs.with_secrets }}]"

          echo "Pushing changes to GitOps repo..."
          git push

          echo "GitOps scaffold pushed successfully!"
